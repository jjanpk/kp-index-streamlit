import pandas as pd
from sklearn.ensemble import RandomForestRegressor
from sklearn.model_selection import train_test_split, GridSearchCV
from sklearn.metrics import mean_squared_error, r2_score
import matplotlib.pyplot as plt
import joblib
from google.colab import files

# üìÇ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV
uploaded = files.upload()

# üìÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
df = pd.read_csv('solarwind.csv')
print("‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:", df.columns.tolist())

# üßπ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏á‡πà‡∏≤‡∏¢
df = df.rename(columns={
    'BZ, nT (GSM)': 'Bz',
    'SW Plasma Speed, km/s': 'Speed',
    'SW Proton Density, N/cm^3': 'Density',
    'Kp index': 'Kp'
})

# ‚öôÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà
df['Speed_Density_Ratio'] = df['Speed'] / (df['Density'] + 1e-6)  # ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏≤‡∏£‡∏®‡∏π‡∏ô‡∏¢‡πå
df['Bz_Squared'] = df['Bz'] ** 2
df['Energy_Flux'] = (df['Speed'] ** 2) * df['Density']

# üéØ ‡πÅ‡∏¢‡∏Å‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏Å‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
feature_cols = ['Bz', 'Speed', 'Density', 'Speed_Density_Ratio', 'Bz_Squared', 'Energy_Flux']
X = df[feature_cols]
y = df['Kp']

X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
param_grid = {
    'n_estimators': [100, 200],
    'max_depth': [10, 20, None],
    'min_samples_split': [2, 5]
}

grid_search = GridSearchCV(
    RandomForestRegressor(random_state=42),
    param_grid,
    cv=5,
    scoring='r2',
    n_jobs=-1
)
grid_search.fit(X_train, y_train)

best_model = grid_search.best_estimator_
print("üìå Best Parameters:", grid_search.best_params_)

# üîÆ ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå
y_pred = best_model.predict(X_test)

# üìä ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå
plt.figure(figsize=(10,5))
plt.plot(y_test.values[:100], label='Actual Values')
plt.plot(y_pred[:100], label='Predicted Values')
plt.xlabel('Sample Index')
plt.ylabel('Kp Index')
plt.title('Comparison of Actual and Predicted Values')
plt.legend()
plt.grid(True)
plt.show()

# üìà ‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢
plt.figure(figsize=(6,6))
plt.scatter(y_test, y_pred)
plt.xlabel('Actual Values (y_test)')
plt.ylabel('Predicted Values (y_pred)')
plt.title('Scatter Plot of Actual vs Predicted')
plt.grid(True)
plt.show()

# ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Kp ‡∏à‡∏£‡∏¥‡∏á ‡∏Å‡∏±‡∏ö Kp ‡∏ó‡∏µ‡πà‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ
print("\n‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö Kp ‡∏à‡∏£‡∏¥‡∏á ‡∏Å‡∏±‡∏ö Kp ‡∏ó‡∏µ‡πà‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô):")
for actual, predicted in zip(y_test.values[:20], y_pred[:20]):
    print(f"Actual Kp: {actual:.2f}  |  Predicted Kp: {predicted:.2f}")

# üìè ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
mse = mean_squared_error(y_test, y_pred)
r2 = r2_score(y_test, y_pred)

print("\nüìê Mean Squared Error (MSE):", mse)
print("üìä R¬≤ Score:", r2)

# üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•
joblib.dump(best_model, 'solar_wind_predictor_model.pkl')
print("\n‚úÖ ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!")

# üîé ‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà
new_data = pd.DataFrame([[-5, 350, 8]], columns=['Bz', 'Speed', 'Density'])
new_data['Speed_Density_Ratio'] = new_data['Speed'] / (new_data['Density'] + 1e-6)
new_data['Bz_Squared'] = new_data['Bz'] ** 2
new_data['Energy_Flux'] = (new_data['Speed'] ** 2) * new_data['Density']

loaded_model = joblib.load('solar_wind_predictor_model.pkl')
prediction = loaded_model.predict(new_data)

print("\nüîÆ ‡∏Ñ‡πà‡∏≤‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå Kp ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà:", prediction)

‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö Kp ‡∏à‡∏£‡∏¥‡∏á ‡∏Å‡∏±‡∏ö Kp ‡∏ó‡∏µ‡πà‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô):
Actual Kp: 3.00  |  Predicted Kp: 10.03
Actual Kp: 3.00  |  Predicted Kp: 15.96
Actual Kp: 10.00  |  Predicted Kp: 10.29
Actual Kp: 17.00  |  Predicted Kp: 24.69
Actual Kp: 7.00  |  Predicted Kp: 19.34
Actual Kp: 30.00  |  Predicted Kp: 30.17
Actual Kp: 27.00  |  Predicted Kp: 26.97
Actual Kp: 17.00  |  Predicted Kp: 17.69
Actual Kp: 33.00  |  Predicted Kp: 27.35
Actual Kp: 40.00  |  Predicted Kp: 38.60
Actual Kp: 13.00  |  Predicted Kp: 9.70
Actual Kp: 33.00  |  Predicted Kp: 27.41
Actual Kp: 40.00  |  Predicted Kp: 35.24
Actual Kp: 17.00  |  Predicted Kp: 13.05
Actual Kp: 7.00  |  Predicted Kp: 13.46
Actual Kp: 10.00  |  Predicted Kp: 20.30
Actual Kp: 30.00  |  Predicted Kp: 14.46
Actual Kp: 7.00  |  Predicted Kp: 15.74
Actual Kp: 7.00  |  Predicted Kp: 11.42
Actual Kp: 30.00  |  Predicted Kp: 41.15

üìê Mean Squared Error (MSE): 67.28885370808153
üìä R¬≤ Score: 0.6122877826469642

‚úÖ ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!

üîÆ ‡∏Ñ‡πà‡∏≤‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå Kp ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà: [24.66334586]