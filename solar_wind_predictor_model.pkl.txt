import pandas as pd
from sklearn.ensemble import RandomForestRegressor
from sklearn.model_selection import train_test_split, GridSearchCV
from sklearn.metrics import mean_squared_error, r2_score
import matplotlib.pyplot as plt
import joblib
from google.colab import files

# ğŸ“‚ à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œ CSV
uploaded = files.upload()

# ğŸ“„ à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
df = pd.read_csv('solarwind.csv')
print("à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”:", df.columns.tolist())

# ğŸ§¹ à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸Šà¸·à¹ˆà¸­à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¹ƒà¸«à¹‰à¹€à¸£à¸µà¸¢à¸à¸‡à¹ˆà¸²à¸¢
df = df.rename(columns={
    'BZ, nT (GSM)': 'Bz',
    'SW Plasma Speed, km/s': 'Speed',
    'SW Proton Density, N/cm^3': 'Density',
    'Kp index': 'Kp'
})

# âš™ï¸ à¹€à¸à¸´à¹ˆà¸¡à¸Ÿà¸µà¹€à¸ˆà¸­à¸£à¹Œà¹ƒà¸«à¸¡à¹ˆ
df['Speed_Density_Ratio'] = df['Speed'] / (df['Density'] + 1e-6)  # à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸«à¸²à¸£à¸¨à¸¹à¸™à¸¢à¹Œ
df['Bz_Squared'] = df['Bz'] ** 2
df['Energy_Flux'] = (df['Speed'] ** 2) * df['Density']

# ğŸ¯ à¹à¸¢à¸à¸Ÿà¸µà¹€à¸ˆà¸­à¸£à¹Œà¸à¸±à¸šà¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢
feature_cols = ['Bz', 'Speed', 'Density', 'Speed_Density_Ratio', 'Bz_Squared', 'Energy_Flux']
X = df[feature_cols]
y = df['Kp']

X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# ğŸ” à¸„à¹‰à¸™à¸«à¸²à¸à¸²à¸£à¸²à¸¡à¸´à¹€à¸•à¸­à¸£à¹Œà¸—à¸µà¹ˆà¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸”
param_grid = {
    'n_estimators': [100, 200],
    'max_depth': [10, 20, None],
    'min_samples_split': [2, 5]
}

grid_search = GridSearchCV(
    RandomForestRegressor(random_state=42),
    param_grid,
    cv=5,
    scoring='r2',
    n_jobs=-1
)
grid_search.fit(X_train, y_train)

best_model = grid_search.best_estimator_
print("ğŸ“Œ Best Parameters:", grid_search.best_params_)

# ğŸ”® à¸à¸¢à¸²à¸à¸£à¸“à¹Œ
y_pred = best_model.predict(X_test)

# ğŸ“Š à¸à¸£à¸²à¸Ÿà¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸„à¹ˆà¸²à¸ˆà¸£à¸´à¸‡à¸à¸±à¸šà¸„à¹ˆà¸²à¸à¸¢à¸²à¸à¸£à¸“à¹Œ
plt.figure(figsize=(10,5))
plt.plot(y_test.values[:100], label='Actual Values')
plt.plot(y_pred[:100], label='Predicted Values')
plt.xlabel('Sample Index')
plt.ylabel('Kp Index')
plt.title('Comparison of Actual and Predicted Values')
plt.legend()
plt.grid(True)
plt.show()

# ğŸ“ˆ à¸à¸£à¸²à¸Ÿà¸à¸²à¸£à¸à¸£à¸°à¸ˆà¸²à¸¢
plt.figure(figsize=(6,6))
plt.scatter(y_test, y_pred)
plt.xlabel('Actual Values (y_test)')
plt.ylabel('Predicted Values (y_pred)')
plt.title('Scatter Plot of Actual vs Predicted')
plt.grid(True)
plt.show()

# âœ… à¹à¸ªà¸”à¸‡à¸œà¸¥ Kp à¸ˆà¸£à¸´à¸‡ à¸à¸±à¸š Kp à¸—à¸µà¹ˆà¸à¸¢à¸²à¸à¸£à¸“à¹Œà¹„à¸”à¹‰
print("\nà¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸š Kp à¸ˆà¸£à¸´à¸‡ à¸à¸±à¸š Kp à¸—à¸µà¹ˆà¸à¸¢à¸²à¸à¸£à¸“à¹Œà¹„à¸”à¹‰ (à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸šà¸²à¸‡à¸ªà¹ˆà¸§à¸™):")
for actual, predicted in zip(y_test.values[:20], y_pred[:20]):
    print(f"Actual Kp: {actual:.2f}  |  Predicted Kp: {predicted:.2f}")

# ğŸ“ à¸„à¹ˆà¸²à¸„à¸§à¸²à¸¡à¹à¸¡à¹ˆà¸™à¸¢à¸³
mse = mean_squared_error(y_test, y_pred)
r2 = r2_score(y_test, y_pred)

print("\nğŸ“ Mean Squared Error (MSE):", mse)
print("ğŸ“Š RÂ² Score:", r2)

# ğŸ’¾ à¸šà¸±à¸™à¸—à¸¶à¸à¹‚à¸¡à¹€à¸”à¸¥
joblib.dump(best_model, 'solar_wind_predictor_model.pkl')
print("\nâœ… à¹‚à¸¡à¹€à¸”à¸¥à¸—à¸µà¹ˆà¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸”à¸–à¸¹à¸à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§!")

# ğŸ” à¸à¸²à¸£à¸à¸¢à¸²à¸à¸£à¸“à¹Œà¹ƒà¸«à¸¡à¹ˆ
new_data = pd.DataFrame([[-5, 350, 8]], columns=['Bz', 'Speed', 'Density'])
new_data['Speed_Density_Ratio'] = new_data['Speed'] / (new_data['Density'] + 1e-6)
new_data['Bz_Squared'] = new_data['Bz'] ** 2
new_data['Energy_Flux'] = (new_data['Speed'] ** 2) * new_data['Density']

loaded_model = joblib.load('solar_wind_predictor_model.pkl')
prediction = loaded_model.predict(new_data)

print("\nğŸ”® à¸„à¹ˆà¸²à¸à¸¢à¸²à¸à¸£à¸“à¹Œ Kp à¸ªà¸³à¸«à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¸¡à¹ˆ:", prediction)
